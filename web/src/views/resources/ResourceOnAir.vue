<i18n>
en:
  resourceList: Resources List
  online: 'On Air '
  download: Download
  minVersionRequired: Min version required to pangeecluster
zh:
  resourceList: 资源包列表
  online: 未下载
  download: 下 载
  minVersionRequired: PangeeCluster最低版本要求
</i18n>

<template>
  <div>
    <ControlBar :title="version">
      <template v-if="resourcePackage">
        <ResourceDownload v-if="meetVersionRequirement" action="download" :source="source"
          :resource="{ package: resourcePackage, tag_name: tag, file_name: file, history: { task_type: 'resource', task_name: version, processing: false, success_tasks: [] } }">
        </ResourceDownload>
        <template v-else>
          <el-tag type="danger" effect="dark">{{ t('minVersionRequired') }}</el-tag>
          <el-tag type="danger" class="app_text_mono">{{ resourcePackage.metadata.pangee_cluster_version.min }}</el-tag>
        </template>
      </template>
    </ControlBar>
    <div class="app_block_title">
      {{ $t('obj.resource') }}
      <el-tag type="warning" effect="dark">
        <el-icon :size="14" style="width: 14px; height: 14px; vertical-align: bottom;">
          <el-icon-cloudy></el-icon-cloudy>
        </el-icon>
        {{ t('online') }}
      </el-tag>
    </div>
    <el-card>
      <el-skeleton v-if="loading" animated></el-skeleton>
      <ResourceDetails v-else-if="resourcePackage" :releaseNote="releaseNote" :resourcePackage="resourcePackage"
        expandAll>
      </ResourceDetails>
    </el-card>
  </div>
</template>

<script>
import mixin from '../../mixins/mixin.js'
import ResourceDetails from './details/ResourceDetails.vue'
import yaml from 'js-yaml'
import ResourceDownload from './ResourceDownload.vue'
import compareVersions from 'compare-versions'

export default {
  mixins: [mixin],
  percentage() {
    return 100
  },
  breadcrumb() {
    return [
      { label: this.t('resourceList'), to: '/settings/resources' },
      { label: this.version },
    ]
  },
  refresh() {
    this.refresh()
  },
  props: {
    tag: { type: String, required: true },
    file: { type: String, required: true },
    version: { type: String, required: true },
    mode: { type: String, required: false, default: 'view' },
  },
  data() {
    return {
      resourcePackage: undefined,
      releaseNote: undefined,
      loading: false,
      source: this.$route.params.source,
    }
  },
  computed: {
    meetVersionRequirement() {
      if (this.resourcePackage === undefined) {
        return false
      }
      return compareVersions(window.PangeeCluster.version.trimed, this.resourcePackage.metadata.pangee_cluster_version.min) >= 0
    },
  },
  components: { ResourceDetails, ResourceDownload },
  mounted() {

    this.refresh()
  },
  methods: {
    async refresh() {
      this.loading = true
      await this.pangeeClusterApi.get(`/resources/remote/${this.tag}`, {
        params: { 
          source: this.source
        }
      }).then(resp => {
        this.resourcePackage = yaml.load(resp.data.data.package)
      }).catch(e => {
        console.log(e)
        this.$message.error('离线环境')
      })
      await this.pangeeClusterApi.get(`/resources/remote/${this.tag}/release_note`, {
        params: { 
          source: this.source
        }
      }).then(resp => {
        this.releaseNote = resp.data.data.release_note
      }).catch(e => {
        console.log(e)
      })
      this.loading = false
    },
  }
}
</script>

<style scoped lang="css"></style>
